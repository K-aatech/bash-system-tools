# --- K'AATECH GOVERNANCE HOOKS ---
repos:
  # --- SECURITY ALWAYS FIRST ---
  - repo: local
    hooks:
      - id: trufflehog
        name: TruffleHog Scan
        # We use file://. to ensure it's a valid URI on Windows and Linux.
        entry: trufflehog git file://. --since-commit HEAD --results=verified,unverified,unknown --fail
        language: system
        pass_filenames: false
        stages: [pre-commit]

  # --- PERMISSIONS GOVERNANCE (Fixers) ---
  # --- BASH EXECUTABLES HOOK ---
  - repo: local
    hooks:
      - id: fix-executables
        name: Fix script permissions (Governance)
        # We use logic that detects whether to use `git update-index` or `chmod` based on the environment, ensuring compatibility across Windows and Linux.       #
        entry: bash -c 'if [[ "$OSTYPE" == "msys" || "$OSTYPE" == "cygwin" ]]; then git ls-files "scripts/*" "audit/*" "hardening/*" "maintenance/*" "deploy/*" "test/unit/*" | grep -v ".gitkeep" | xargs -I {} git update-index --chmod=+x {}; else find scripts/ audit/ hardening/ maintenance/ deploy/ test/unit/ -type f ! -name ".gitkeep" -exec chmod +x {} + 2>/dev/null || true; fi'
        language: system
        stages: [pre-commit]
        pass_filenames: false

      - id: remove-executables
        name: Remove library permissions (Governance)
        entry: bash -c 'if [[ "$OSTYPE" == "msys" || "$OSTYPE" == "cygwin" ]]; then git ls-files "lib/*" "test/lib/*" "docs/*.md" | xargs -I {} git update-index --chmod=-x {}; else chmod -x lib/* test/lib/* docs/*.md 2>/dev/null || true; fi'
        language: system
        stages: [pre-commit]
        pass_filenames: false

  # --- SYNTAX AND UTILITY: Format validation ---
  # --- JSON, YAML AND UTILITY HOOKS ---
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: 3e8a8703264a2f4a69428a0aa4dcb512790b2c8c # v6.0.0
    hooks:
      - id: check-json # Validate JSON syntax
        exclude: ^.vscode/ # Exclude the VS Code folder to prevent errors due to comments
      - id: check-yaml # Validate YAML syntax
        args: [--allow-multiple-documents]
      - id: end-of-file-fixer # Ensure an empty line at the end of files
      - id: trailing-whitespace # Remove unnecessary spaces at the end of the line
      - id: mixed-line-ending # Final reinforcement to secure LF line endings
        args: ["--fix=lf"]
      - id: check-executables-have-shebangs
        name: Integrity - Ensure shebang in executables
      - id: check-shebang-scripts-are-executable
        name: Integrity - Ensure scripts with shebang are +x
        # Excluimos archivos que no son scripts pero podr√≠an tener contenido similar
        exclude: ^(docs/|lib/|test/lib/|.*\.md)$

  # --- CODE QUALITY (Linters) ---
  # --- MARKDOWN HOOK ---
  - repo: https://github.com/igorshubovych/markdownlint-cli
    rev: 76b3d32d3f4b965e1d6425253c59407420ae2c43 # v0.47.0
    hooks:
      - id: markdownlint
        args: ["--config", ".markdownlint.yaml", "--fix"]

  # --- BASH LINT HOOK ---
  - repo: https://github.com/shellcheck-py/shellcheck-py
    rev: 745eface02aef23e168a8afb6b5737818efbea95 # v0.11.0.1
    hooks:
      - id: shellcheck
        args: ["--severity=warning"] # Optional: to be strict as the CI

  # --- CONVENTIONAL COMMITS HOOK ---
  - repo: https://github.com/compilerla/conventional-pre-commit
    rev: 91ab4bf57e58b32adf1a122681f6ebe164d081c8 # v4.4.0
    hooks:
      - id: conventional-pre-commit
        stages: [commit-msg]
        args:
          [
            "feat",
            "fix",
            "docs",
            "style",
            "refactor",
            "perf",
            "test",
            "build",
            "ci",
            "chore",
            "revert",
          ]
