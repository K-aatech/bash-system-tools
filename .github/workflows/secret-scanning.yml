name: Secret Scanning (TruffleHog)

permissions:
  contents: read
  security-events: write

on:
  pull_request:
    branches:
    - main
  schedule:
  - cron: '0 4 * * 3'                 # Wednesday 04:00 UTC

concurrency:
  group: trufflehog-${{ github.workflow }}-${{ github.event_name }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  trufflehog-scan:
    name: TruffleHog OSS Scan
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout (full history)
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Download and verify TruffleHog
        run: |
          VERSION=3.93.3
          FILE=trufflehog_${VERSION}_linux_amd64.tar.gz
          echo "‚è≥ Downloading TruffleHog v$VERSION..."
          curl -sSLO https://github.com/trufflesecurity/trufflehog/releases/download/v${VERSION}/${FILE}
          curl -sSLO https://github.com/trufflesecurity/trufflehog/releases/download/v${VERSION}/trufflehog_${VERSION}_checksums.txt

          # Grep should extract the line from the actual file and pass it to the validator.
          if grep "${FILE}" trufflehog_${VERSION}_checksums.txt | sha256sum -c -; then
              echo "‚úÖ Checksum verified: Integrity Guaranteed."
          else
              echo "‚ùå CRITICAL: Checksum mismatch!"
              exit 1
          fi

          tar -xzf ${FILE}
          chmod +x trufflehog

          echo "$(pwd)" >> $GITHUB_PATH

      - name: Run TruffleHog (Git scan)
        id: scan_step
        run: |
          SCAN_TARGET="file://$(pwd)"
          EXTRA_ARGS="--results=verified,unverified,unknown --json"

          if [ "${{ github.event_name }}" == "pull_request" ]; then
          echo "üîç Scanning PR Diff (since ${{ github.event.pull_request.base.sha }})..."
            trufflehog git $SCAN_TARGET --since-commit ${{ github.event.pull_request.base.sha }} $EXTRA_ARGS > trufflehog.json || true
          else
            echo "üîç Running Scheduled Full Scan..."
            trufflehog git $SCAN_TARGET $EXTRA_ARGS > trufflehog.json || true
          fi

      # Convert JSON ‚Üí SARIF
      - name: Convert JSON to SARIF
        id: converter
        if: always()
        run: |
          if [ ! -s trufflehog.json ]; then
            echo "‚ú® No secrets found. Repository is clean."
            echo "has_findings=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "üîÑ Converting NDJSON findings to SARIF format..."
          jq -s '
          {
            "$schema": "https://json.schemastore.org/sarif-2.1.0.json",
            version: "2.1.0",
            runs: [{
              tool: {
                driver: {
                  name: "TruffleHog",
                  informationUri: "https://github.com/trufflesecurity/trufflehog",
                  rules: (map({id: .DetectorName, name: .DetectorName}) | unique)
                }
              },
              results: map({
                ruleId: .DetectorName,
                level: (if .Verified == true then "error" else "warning" end),
                message: { text: "Secret detected: \(.DetectorName)" },
                locations: [{
                  physicalLocation: {
                    artifactLocation: {
                      uri: (.SourceMetadata.Data.Git.file // "unknown")
                    },
                    region: {
                      startLine: ((.SourceMetadata.Data.Git.line // 1) | tonumber)
                    }
                  }
                }]
              })
            }]
          }' trufflehog.json > trufflehog.sarif

          echo "has_findings=true" >> $GITHUB_OUTPUT
          echo "‚úÖ SARIF conversion complete."

      - name: Validate and Upload SARIF report
        if: always() && steps.converter.outputs.has_findings == 'true'
        uses: github/codeql-action/upload-sarif@9e907b5e64f6b83e7804b09294d44122997950d6 # v4.32.3
        with:
          sarif_file: trufflehog.sarif
          checkout_path: ${{ github.workspace }}
          sha: ${{ github.event.pull_request.head.sha || github.sha }}
          ref: ${{ github.ref }}

      # Fail explicitly if findings exist
      - name: Enforce fail on detection
        if: always() && steps.converter.outputs.has_findings == 'true'
        run: |
          COUNT=$(jq -s 'length' trufflehog.json)
          echo "‚ùå FAILED: $COUNT potential secrets detected!"
          exit 1
